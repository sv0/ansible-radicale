---
- name: Include tasks from certificate.yml
  include_tasks:
    file: certificate.yml
    apply:
      tags:
        - cert
  tags:
    - cert

- name: Put TLS cert to {{ radicale_tls_certificate }}
  copy:
    src: "{{ certificate_fullchain }}"
    dest: "{{ radicale_tls_certificate }}"
    owner: root
    group: root
    mode: 0644
  tags:
    - cert
  notify: Restart radicale

- name: Put TLS certificate private {{ radicale_tls_private_key }}
  copy:
    src: "{{ certificate_privkey }}"
    dest: "{{ radicale_tls_private_key }}"
    owner: root
    group: "{{ radicale_group_ssl }}"
    mode: 0640
  tags:
    - cert
  notify: Restart radicale

- name: Add radicale user to group {{ radicale_group_ssl }}
  user:
    name: "{{ radicale_user }}"
    groups: "{{ radicale_group_ssl }}"
    append: true

- name: Create directory {{ radicale_pidfile | dirname }}
  file:
    path: "{{ radicale_pidfile | dirname }}"
    state: directory
    mode: 0755

- name: Create directory /var/lib/radicale
  file:
    path: /var/lib/radicale
    state: directory
    owner: "{{ radicale_user }}"
    group: "{{ radicale_group }}"
    mode: 0755

# filesystem_folder = /var/lib/radicale/collections

- name: Install radicale
  package:
    name:
      - python3-radicale
      - radicale

- name: Enable radicale
  lineinfile:
    path: /etc/default/radicale
    line: "ENABLE_RADICALE=yes"
    regex: "^#ENABLE_RADICALE"

- name: Create /etc/radicale/config
  template:
    src: config.j2
    dest: /etc/radicale/config
    owner: root
    group: root
    mode: 0644
  notify: Restart radicale

- name: Create systemd service file
  template:
    src: radicale.service.j2
    dest: /etc/systemd/system/radicale.service
    mode: 0644
    owner: root
    group: root
  notify:
    - Reload systemd
    - Restart radicale

- name: Enable radicale service
  systemd:
    name: radicale
    enabled: true

- name: Create radicale users
  community.general.htpasswd:
    path: /etc/radicale/users
    name: "{{ item.username }}"
    password: "{{ item.password }}"
    owner: "{{ radicale_user }}"
    group: "{{ radicale_group }}"
    mode: 0640
  with_items: "{{ radicale_user_list }}"
  when:
    - radicale_user_list is defined
    - (radicale_user_list)
